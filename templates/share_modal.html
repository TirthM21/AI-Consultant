<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title" id="shareModalLabel">
          <i class="fas fa-share-alt me-2"></i>Share Consultation
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="shareForm" method="POST" action="{{ url_for('share_consultation', consultation_id=consultation.id) }}">
          <div class="form-group mb-3">
            <label for="emails" class="form-label">Email Addresses</label>
            <textarea class="form-control bg-dark text-white border-secondary" id="emails" name="emails" 
                      rows="3" placeholder="Enter email addresses separated by commas"></textarea>
            <small class="text-muted">Example: john@example.com, jane@example.com</small>
          </div>
          
          <div class="form-group mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="can_edit" name="can_edit">
              <label class="form-check-label" for="can_edit">
                Allow recipients to edit notes
              </label>
            </div>
          </div>
          
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-paper-plane me-2"></i>Send Invites
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
        
        <div id="shareResults" class="mt-3" style="display: none;">
          <h6>Share Links:</h6>
          <div id="shareLinksList"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Notes Section -->
<div class="content-card mt-4">
  <h3 class="mb-4">
    <i class="fas fa-sticky-note me-2"></i>Collaborative Notes
    <button class="btn btn-sm btn-outline-primary float-end" onclick="showAddNote()">
      <i class="fas fa-plus me-1"></i>Add Note
    </button>
  </h3>
  
  <div id="addNoteForm" style="display: none;" class="mb-3">
    <div class="form-group">
      <textarea class="form-control bg-dark text-white border-secondary" id="noteContent" 
                rows="3" placeholder="Add your collaborative note..."></textarea>
    </div>
    <div class="d-flex gap-2 mt-2">
      <button class="btn btn-sm btn-primary" onclick="addNote()">
        <i class="fas fa-save me-1"></i>Save Note
      </button>
      <button class="btn btn-sm btn-secondary" onclick="hideAddNote()">Cancel</button>
    </div>
  </div>
  
  <div id="notesList">
    <!-- Notes will be loaded here -->
  </div>
</div>

<script>
function showAddNote() {
  document.getElementById('addNoteForm').style.display = 'block';
}

function hideAddNote() {
  document.getElementById('addNoteForm').style.display = 'none';
  document.getElementById('noteContent').value = '';
}

function addNote() {
  const content = document.getElementById('noteContent').value.trim();
  if (!content) {
    alert('Please enter a note');
    return;
  }
  
  fetch('/consultation/{{ consultation.id }}/notes', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: `content=${encodeURIComponent(content)}`
  })
  .then(response => response.json())
  .then(data => {
    hideAddNote();
    loadNotes();
  })
  .catch(error => {
    console.error('Error adding note:', error);
    alert('Failed to add note');
  });
}

function loadNotes() {
  fetch('/consultation/{{ consultation.id }}/notes')
    .then(response => response.json())
    .then(notes => {
      const notesList = document.getElementById('notesList');
      
      if (notes.length === 0) {
        notesList.innerHTML = '<p class="text-muted">No notes yet. Be the first to add one!</p>';
        return;
      }
      
      notesList.innerHTML = notes.map(note => `
        <div class="content-card mb-2">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong>${note.author}</strong>
              <small class="text-muted ms-2">${note.created_at}</small>
            </div>
          </div>
          <div class="mt-2">${note.content}</div>
        </div>
      `).join('');
    })
    .catch(error => {
      console.error('Error loading notes:', error);
    });
}

document.getElementById('shareForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  
  fetch(this.action, {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    const resultsDiv = document.getElementById('shareResults');
    const linksList = document.getElementById('shareLinksList');
    
    linksList.innerHTML = data.shared_with.map(item => `
      <div class="mb-2">
        <strong>${item.email}:</strong>
        <div class="input-group mt-1">
          <input type="text" class="form-control bg-dark text-white border-secondary" 
                 value="${item.link}" readonly>
          <button class="btn btn-outline-secondary" onclick="copyToClipboard('${item.link}')">
            <i class="fas fa-copy"></i>
          </button>
        </div>
      </div>
    `).join('');
    
    resultsDiv.style.display = 'block';
    
    // Close modal after successful share
    setTimeout(() => {
      const modal = bootstrap.Modal.getInstance(document.getElementById('shareModal'));
      if (modal) modal.hide();
    }, 2000);
  })
  .catch(error => {
    console.error('Error sharing:', error);
    alert('Failed to share consultation');
  });
});

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert('Link copied to clipboard!');
  });
}

// Load notes when page loads
document.addEventListener('DOMContentLoaded', function() {
  loadNotes();
});
</script>